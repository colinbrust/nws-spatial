<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montana Weather Alerts</title>
    <!-- Include Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/flatgeobuf@3.22.0/dist/flatgeobuf-geojson.min.js"></script>
    <!-- Add your Leaflet map script -->
</head>
<body>
    <!-- Create a container for the map -->
    <div id="map" style="height: 98vh;"></div>
    <script>

        const colors = {
            "Winter Storm Warning": "#ff69b4",
            "Flood Warning": "#00ff00",
            "Gale Warning": "#dda0dd",
            "Winter Weather Advisory": "#7b68ee",
            "Avalanche Warning": "#1e90ff",
            "Wind Chill Advisory": "#afeeee",
            "Flood Advisory": "#00ff7f",
            "Coastal Flood Advisory": "#7cfc00",
            "High Surf Advisory": "#ba55d3",
            "Heavy Freezing Spray Warning": "#00bfff",
            "Dense Fog Advisory": "#708090",
            "Small Craft Advisory": "#d8bfd8",
            "Brisk Wind Advisory": "#d8bfd8",
            "Wind Advisory": "#d2b48c",
            "Freezing Fog Advisory": "#008080",
            "Rip Current Statement": "#40e0d0",
            "Beach Hazards Statement": "#40e0d0",
            "Flood Watch": "#2e8b57",
            "Special Weather Statement": "#ffe4b5",
            "Marine Weather Statement": "#ffefd5",
            "Air Quality Alert": "#808080",
            "Hydrologic Outlook": "#90ee90"
        }

        function color_from_event(e) {
            return colors[e] || "rgba(0, 0, 0, 0)"; 
        }
        var map = L.map('map').setView(new L.LatLng(47, -109), 7);
        var tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

        (async() => {

            let alert_response = await fetch("https://data.climate.umt.edu/website/nws/first_alerts.json");
            let alert_coloring = await alert_response.json();

            const response = await fetch('https://data.climate.umt.edu/website/mt-zones.fgb');

            const counties = await fetch("https://data.climate.umt.edu/mca/fgb/mt_counties.fgb");
            for await (const f of flatgeobuf.deserialize(counties.body)) {
                L.geoJSON(f, {
                    style: function(feature) {
                        return {
                            fillColor: "rgba(0, 0, 0, 0)",
                            fillOpacity: 0.9,
                            color: "black",
                            weight: 1,
                        }                        
                    }
                }).addTo(map);
            }

            for await (const f of flatgeobuf.deserialize(response.body)) {
                L.geoJSON(f, {
                    onEachFeature: function (feature, layer) {
                        var popupUrl = 'https://data.climate.umt.edu/website/nws/alert_pages/' + feature.properties.id + '.html';

                        // Function to check if the URL exists
                        function urlExists(url, callback) {
                            var xhr = new XMLHttpRequest();
                            xhr.onreadystatechange = function () {
                                if (xhr.readyState === 4) {
                                    callback(xhr.status < 400);
                                }
                            };
                            xhr.open('HEAD', url, true);
                            xhr.send();
                        }

                        // Function to add popup if URL exists
                        function addPopup() {
                            urlExists(popupUrl, function (exists) {
                                if (exists) {
                                    // URL exists, add the popup
                                    var popup = '<iframe src="' + popupUrl + '" width="500" height="500"></iframe>';
                                    layer.bindPopup(popup, { maxWidth: 500 });
                                } 
                            });
                        }

                        addPopup();
                    },
                    style: function(feature) {
                        return {
                            fillColor: color_from_event(alert_coloring[feature.properties.id]),
                            fillOpacity: 0.9,
                            color: color_from_event(alert_coloring[feature.properties.id]),
                            opacity: 0.9, 
                            weight: 1,
                        }
                    }      
                }).addTo(map);
            }


        })();

    </script>
</body>
</html>

